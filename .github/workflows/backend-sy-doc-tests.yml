name: Symphony Doc Tests (sy-*)

on:
  push:
    paths:
      - 'apps/backend/crates/**/sy-*/**'
      - 'apps/backend/Cargo.toml'
      - 'apps/backend/Cargo.lock'


env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  # Wait for cache to be ready
  wait-for-cache:
    uses: ./.github/workflows/cache-dependencies.yml
  
  doc-test-sy-crates:
    runs-on: ubuntu-latest
    needs: wait-for-cache
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Restore Rust dependencies cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "apps/backend"
        cache-on-failure: true
        shared-key: "symphony-backend"
        key: ${{ needs.wait-for-cache.outputs.cache-key }}
    
    - name: Run sy-* doc tests
      working-directory: apps/backend
      run: |
        # Test sy-* crates documentation individually
        echo "Testing sy-* crate documentation (Symphony code)..."
        
        SY_CRATES=(
          "sy-commons"
          "sy-core-ports"
        )
        
        PASSED=0
        FAILED=0
        
        for crate in "${SY_CRATES[@]}"; do
          echo "Testing documentation for crate: $crate"
          
          # Check if crate exists
          if [ -d "crates/core/$crate" ] || [ -d "crates/utils/$crate" ]; then
            # Run doc tests (strict - must pass)
            if cargo test --package "$crate" --doc; then
              echo "✅ Doc tests passed for $crate"
              ((PASSED++))
            else
              echo "❌ Doc tests FAILED for $crate"
              ((FAILED++))
              exit 1  # Fail fast for sy-* crates
            fi
            
            # Generate documentation to check for warnings (strict - must pass)
            if cargo doc --package "$crate" --no-deps --document-private-items; then
              echo "✅ Documentation generation passed for $crate"
            else
              echo "❌ Documentation generation FAILED for $crate"
              exit 1  # Fail fast for sy-* crates
            fi
          else
            echo "⚠️  Crate $crate not found, skipping..."
          fi
          
          echo "---"
        done
        
        echo "Symphony documentation testing summary:"
        echo "Passed: $PASSED"
        echo "Failed: $FAILED"
        echo "All sy-* crates must have perfect documentation!"