name: XI-Editor Tests (xi-*)

on:
  push:
    paths:
      - 'apps/backend/crates/**/xi-*/**'
      - 'apps/backend/Cargo.toml'
      - 'apps/backend/Cargo.lock'


env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  # Wait for cache to be ready
  wait-for-cache:
    uses: ./.github/workflows/cache-dependencies.yml
  
  test-xi-crates:
    runs-on: ubuntu-latest
    needs: wait-for-cache
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Restore Rust dependencies cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "apps/backend"
        cache-on-failure: true
        shared-key: "symphony-backend"
        key: ${{ needs.wait-for-cache.outputs.cache-key }}
    
    - name: Restore cargo tools cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/cargo-nextest
          ~/.cargo/bin/cargo-fuzz
          ~/.cargo/bin/cargo-llvm-cov
          ~/.cargo/bin/cargo-deny
          ~/.cargo/bin/tauri
        key: cargo-tools-${{ runner.os }}-${{ needs.wait-for-cache.outputs.rust-version }}-v2
    
    - name: Verify cached tools
      run: |
        echo "Verifying cached tools are available..."
        cargo nextest --version || (echo "cargo-nextest not cached, installing..." && cargo install cargo-nextest --locked)
        echo "Tools verified successfully"
    
    - name: Run xi-* crate tests
      working-directory: apps/backend
      run: |
        # Test xi-* crates individually to handle compilation failures
        echo "Testing xi-* crates individually (legacy XI-editor code)..."
        
        # List of known xi-* crates
        XI_CRATES=(
          "xi-core-lib"
          "xi-lsp-lib" 
          "xi-rpc"
          "xi-rope"
          "xi-trace"
          "xi-unicode"
          "xi-plugin-lib"
          "xi-syntect-plugin"
        )
        
        PASSED=0
        FAILED=0
        
        for crate in "${XI_CRATES[@]}"; do
          echo "Testing crate: $crate"
          
          # Check if crate exists
          if [ -d "crates/core/$crate" ] || [ -d "crates/utils/$crate" ] || [ -d "crates/plugins/$crate" ]; then
            # Try to run tests, continue on failure (legacy code)
            if cargo nextest run --package "$crate" 2>/dev/null; then
              echo "✅ Tests passed for $crate"
              ((PASSED++))
            else
              echo "❌ Tests failed for $crate (compilation or test failure)"
              ((FAILED++))
            fi
            
            # Try to run doc tests, continue on failure (legacy code)
            if cargo test --package "$crate" --doc 2>/dev/null; then
              echo "✅ Doc tests passed for $crate"
            else
              echo "❌ Doc tests failed for $crate (compilation or test failure)"
            fi
          else
            echo "⚠️  Crate $crate not found, skipping..."
          fi
          
          echo "---"
        done
        
        echo "XI-* crate testing summary:"
        echo "Passed: $PASSED"
        echo "Failed: $FAILED"
        echo "Note: Failures expected for legacy XI-editor code with compilation issues"
        echo "This workflow monitors XI-editor health but doesn't block development"