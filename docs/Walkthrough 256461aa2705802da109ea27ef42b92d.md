# Walkthrough

## ğŸ“– Scenario

**Developer X** wants to create an extension that shows beautiful charts for developer productivity tracking. The extension needs the **Recharts** library, but it's not included in the base application bundle.

---

## ğŸš€ Developer X's Journey

### Step 1: ğŸ” Check Available Libraries

**Developer X** first checks what's available in the platform:

```bash
# Option A: CLI Command
$ myapp-cli libs list
Available libraries:
  âœ… react (built-in)
  âœ… shadcn-ui (built-in)
  âŒ recharts (not installed)
  âŒ d3 (not installed)
  âŒ plotly (not installed)

# Option B: API Function (inside extension)
const availableLibs = await window.__TAURI__.invoke('get_available_libraries');
console.log(availableLibs);
// { react: true, shadcn: true, recharts: false }

```

### Step 2: ğŸ“¦ Request Library Installation

**Developer X** needs Recharts, so they request it:

```bash
# Option A: CLI Command (Recommended)
$ myapp-cli libs install recharts
ğŸ” Checking recharts availability...
ğŸ“¦ Library: recharts@2.8.0 (Size: 2.1MB)
ğŸ“‹ Dependencies: react, react-dom
ğŸ”’ Source: https://unpkg.com/recharts@2.8.0
â“ Install recharts for visualization features? (y/n): y
â¬‡ï¸  Downloading...  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%
âœ… recharts installed successfully!
ğŸ¯ Available in extensions as: window.Recharts

# Option B: API Function (Programmatic)
const result = await window.__TAURI__.invoke('request_library', {
  name: 'recharts',
  version: '2.8.0',
  reason: 'Data visualization for productivity extension'
});
// Shows user consent dialog automatically

```

### Step 3: âœ… Verify Installation

```bash
# CLI Verification
$ myapp-cli libs list
Available libraries:
  âœ… react (built-in)
  âœ… shadcn-ui (built-in)
  âœ… recharts (installed) - 2.1MB

# Or programmatically
const isAvailable = await window.__TAURI__.invoke('check_library', { name: 'recharts' });
console.log('Recharts ready:', isAvailable);

```

### Step 4: ğŸ› ï¸ Write Extension Code

Now **Developer X** can write their extension:

```rust
// extension/src/lib.rs
pub struct ProductivityChartExtension {
    data: Vec<ProductivityData>,
}

impl UIExtension for ProductivityChartExtension {
    fn render(&self, context: &RenderContext) -> Result<VirtualNode, RenderError> {
        // Create chart using Recharts components
        let chart = VirtualNode {
            id: "productivity-chart".to_string(),
            component_type: ComponentType::External {
                library: "recharts".to_string(),
                component: "LineChart".to_string(),
            },
            props: {
                let mut props = HashMap::new();
                props.insert("data".to_string(), json!(self.data));
                props.insert("width".to_string(), json!(800));
                props.insert("height".to_string(), json!(400));
                props
            },
            children: vec![
            // ... Child virtual nodes
						]
        Ok(chart)
    }
}

```

### Step 5: ğŸš€ Test Extension

```bash
# Load extension for testing
$ myapp-cli ext load ./productivity-extension
ğŸ” Analyzing extension dependencies...
âœ… All dependencies satisfied:
   - recharts âœ… (already installed)
   - react âœ… (built-in)
ğŸ¯ Extension loaded successfully!

# Test in development mode
$ myapp-cli ext dev ./productivity-extension
ğŸš€ Development server started on port 3001
ğŸ”„ Hot reload enabled

```

---

## âš™ï¸ What Happens Internally

When **Developer X** runs `myapp-cli libs install recharts`, here's what happens behind the scenes:

### ğŸ¯ Option 1: CDN Download Strategy

```mermaid
sequenceDiagram
    participant Dev as Developer X
    participant CLI as CLI Tool
    participant Tauri as Tauri Backend
    participant CDN as CDN (unpkg.com)
    participant FS as File System

    Dev->>CLI: libs install recharts
    CLI->>Tauri: request_library("recharts")
    Tauri->>Tauri: Check local cache
    Tauri->>CDN: GET recharts@2.8.0
    CDN->>Tauri: Library bundle (2.1MB)
    Tauri->>FS: Save to app_data/libraries/
    Tauri->>CLI: Installation success
    CLI->>Dev: âœ… recharts ready!

```

**Internal Steps:**

1. **ğŸ” Cache Check**: Look in `~/.myapp/libraries/recharts/`
2. **ğŸ“‹ Metadata Fetch**: Get package info from CDN
3. **ğŸ›¡ï¸ Security Scan**: Verify integrity and whitelist
4. **â¬‡ï¸ Download**: Fetch pre-built UMD bundle
5. **ğŸ’¾ Local Storage**: Save to `libraries/recharts-2.8.0.js`
6. **ğŸ“ Registry Update**: Add to `installed_libraries.json`
7. **âœ… Success**: Ready for extensions to use

### ğŸ¯ Option 2: Package Manager Strategy âš ï¸ **PROBLEMATIC**

```mermaid
sequenceDiagram
    participant Dev as Developer X
    participant CLI as CLI Tool
    participant Tauri as Tauri Backend
    participant NPM as NPM Registry
    participant Node as Node.js Process

    Dev->>CLI: libs install recharts
    CLI->>Tauri: request_library("recharts")
    Tauri->>Tauri: Check if Node.js exists
    alt Node.js Missing
        Tauri->>CLI: âŒ Error: Node.js required
        CLI->>Dev: Please install Node.js first
    else Node.js Available
        Tauri->>Node: spawn npm install recharts
        Node->>NPM: Download package + deps
        NPM->>Node: Package files
        Node->>Tauri: Installation complete
        Tauri->>Tauri: Build UMD bundle
        Tauri->>CLI: Bundle ready
        CLI->>Dev: âœ… recharts ready!
    end

```

**ğŸš« Major Problems:**

1. **ğŸ“¦ NPM Install**: Requires Node.js + npm on user's machine
2. **ğŸ”¨ Bundle Build**: Needs webpack/rollup + build tools
3. **ğŸ§¹ Dependencies**: Native modules may fail to compile
4. **ğŸ’¾ Environment**: Different OS/architectures cause issues
5. **ğŸ“ Support**: Users blame YOUR app when npm fails
6. **âœ… Complexity**: Way too much for end users

**âŒ Why This Fails:**

- Most end users don't have Node.js
- Corporate firewalls block npm registry
- Different Node versions cause conflicts
- Native dependencies break on different architectures
- Users expect apps to be self-contained

### ğŸ¯ Option 3: Hybrid Strategy (Recommended)

**ğŸ’¡ This is NOT Option 1 + Option 2!**
It's **Enhanced Option 1** with smart caching and user consent.

```mermaid
sequenceDiagram
    participant Dev as Developer X
    participant CLI as CLI Tool
    participant Tauri as Tauri Backend
    participant Cache as Local Cache
    participant CDN as Pre-built CDN
    participant User as User Consent

    Dev->>CLI: libs install recharts
    CLI->>Tauri: request_library("recharts")
    Tauri->>Cache: Check local cache
    alt Cache Hit
        Cache->>Tauri: Found recharts-2.8.0.umd.js
        Tauri->>CLI: âœ… Using cached version
    else Cache Miss
        Tauri->>User: Show consent dialog
        User->>Tauri: Approve installation
        Tauri->>CDN: GET pre-built UMD bundle
        Note over CDN: unpkg.com/recharts@2.8.0/umd/Recharts.js
        CDN->>Tauri: Ready-to-use library bundle
        Tauri->>Cache: Save recharts-2.8.0.umd.js
        Tauri->>CLI: âœ… Downloaded and cached
    end
    CLI->>Dev: recharts ready!

```

**ğŸ”‘ Key Difference from Option 2:**

- **âŒ No Node.js**: Downloads pre-built bundles, not source code
- **âŒ No npm install**: No package manager required on user machine
- **âŒ No bundling**: CDN serves ready-to-use UMD files
- **âœ… Pure JavaScript**: Just downloads .js files and loads them

**Internal Steps:**

1. **ğŸ” Local Check**: Search in `app_data/libraries/recharts-2.8.0.umd.js`
2. **ğŸ‘¤ User Consent**: Show permission dialog (first time only)
3. **â¬‡ï¸ Direct Download**: Fetch pre-built UMD from `unpkg.com/recharts/umd/Recharts.js`
4. **ğŸ›¡ï¸ Security**: Verify checksums and signatures
5. **ğŸ’¾ File Cache**: Save `.js` file for offline use
6. **ğŸ“Š Registry**: Update `installed_libraries.json`
7. **âœ… Runtime Load**: `<script>` tag injection or dynamic import

---

## ğŸ“‹ Library Management Commands

**Developer X** has these tools available:

```bash
# List all available libraries
$ myapp-cli libs list

# Search for libraries
$ myapp-cli libs search visualization
ğŸ“Š Found 3 visualization libraries:
   - recharts (React charts)
   - d3 (Low-level data viz)
   - plotly (Interactive plots)

# Install specific version
$ myapp-cli libs install recharts@2.7.0

# Remove library
$ myapp-cli libs remove recharts
âš ï¸  This library is used by 2 extensions:
   - productivity-tracker
   - sales-dashboard
Continue? (y/n):

# Update library
$ myapp-cli libs update recharts
ğŸ“¦ recharts 2.8.0 â†’ 2.9.1 available
ğŸ“‹ Breaking changes: None
âœ… Safe to update

# Clear cache
$ myapp-cli libs cache clear
ğŸ§¹ Cleared 45MB of cached libraries

```

---

## ğŸ”§ Extension Development Workflow

### Local Development

```bash
# Create new extension
$ myapp-cli ext new productivity-charts
ğŸ“ Created extension template
ğŸ“¦ Dependencies: Add to extension.toml

# Declare library dependencies (extension.toml)
[dependencies]
recharts = "^2.8.0"
d3 = "^7.0.0"

# Auto-install dependencies
$ myapp-cli ext dev
ğŸ” Checking dependencies...
âŒ recharts not installed
â“ Install recharts@2.8.0? (y/n): y
â¬‡ï¸  Installing... âœ… Done
ğŸš€ Starting dev server...

```

### Production Release

```bash
# Package extension
$ myapp-cli ext build
ğŸ“¦ Building extension...
ğŸ” Dependency check:
   âœ… recharts@2.8.0 (external)
   âœ… react (built-in)
ğŸ“‹ Creating manifest...
âœ… Extension ready: productivity-charts.ext

# The .ext file includes:
# - Extension code
# - Dependency requirements
# - Metadata and permissions

```

---

## ğŸ›¡ï¸ Security & Trust Model

### What Users See

When **Developer X's** extension is installed by end users:

```bash
$ myapp-cli ext install productivity-charts.ext
ğŸ“‹ Extension: Productivity Charts v1.0.0
ğŸ‘¤ Author: Developer X
ğŸ” Permissions requested:
   - Read file system (productivity data)
   - Network access (sync data)
ğŸ“¦ Dependencies needed:
   - recharts@2.8.0 (2.1MB) - Data visualization
â“ Install this extension? (y/n): y
â¬‡ï¸  Installing dependencies... âœ… Done
ğŸ¯ Extension installed successfully!

```

---

*This walkthrough shows **Developer X** exactly what commands to run, what code to write, and what happens internally when libraries are installed on-demand in your production Tauri application!*